<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>â›º</title>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: Arial, sans-serif;
      }
      #ground {
        position: relative;
        height: 500px;
      }
      #entry {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        bottom: 105px;
        pointer-events: none;
      }
      .link {
        stroke: black;
        stroke-width: 2.5px;
      }
      .node {
        cursor: move;
        fill: black;
        stroke: white;
        stroke-width: 2px;
      }
      .entry {
        stroke: black;
        stroke-width: 2;
        stroke-dasharray: 6 6;
      }
    </style>
  </head>
  <body>
    <main>
      <div id="ground"></div>
    </main>
  </body>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script type="module">
    const ground = document.getElementById("ground");
    const width = window.innerWidth;
    const centerX = width / 2;
    const height = 500;
    const bottom = height - 100;
    const tentHeight = 130;
    const lineOffset = 3;
    const bflCoords = { x: centerX - 100, y: bottom };
    const bfrCoords = { x: centerX + 100, y: bottom };
    const entryOffset = { x: 50, y: 30 };

    let tCoords = { x: centerX, y: bottom - tentHeight };

    let nodes = [
      { id: "bfl", fx: bflCoords.x, fy: bfrCoords.y },
      { id: "bfr", fx: bfrCoords.x, fy: bfrCoords.y },
      { id: "bbl", fx: centerX - 25, fy: bottom - 45 },
      { id: "bbr", fx: centerX + 25, fy: bottom - 45 },
      { id: "t", fx: tCoords.x, fy: tCoords.y }
    ];
    let links = [
      { source: "bfl", target: "bfr" },
      { source: "bbl", target: "bbr" },
      { source: "bfl", target: "bbl" },
      { source: "bfr", target: "bbr" },
      { source: "bfl", target: "t" },
      { source: "bfr", target: "t" },
      { source: "bbl", target: "t" },
      { source: "bbr", target: "t" }
    ];
    let entryPoints = [
      [bflCoords.x + entryOffset.x, bflCoords.y],
      [tCoords.x, tCoords.y + entryOffset.y],
      [centerX + 100 - entryOffset.x, bottom]
    ];

    const entryCurve = d3.line().curve(d3.curveNatural);
    const svg = d3.create("svg").attr("viewBox", [0, 0, width, height]);

    const link = svg
      .selectAll(".link")
      .data(links)
      .join("line")
      .classed("link", true);

    const node = svg
      .selectAll(".node")
      .data(nodes)
      .join("circle")
      .attr("r", 6)
      .classed("node", true);

    const entry = svg.append('path')
      .attr('d', entryCurve(entryPoints))
      .attr('fill', 'none')
      .classed("entry", true);

    function tick(x) {
      link
        .attr("x1", d => d.source.x)
        .attr("y1", d => d.source.y)
        .attr("x2", d => d.target.x)
        .attr("y2", d => d.target.y);
      node
        .attr("cx", d => d.x)
        .attr("cy", d => d.y);
    }

    const simulation = d3
      .forceSimulation()
      .nodes(nodes)
      .force("charge", d3.forceManyBody())
      .force("center", d3.forceCenter(width / 2, height / 2))
      .force("link", d3.forceLink(links).id(d => d.id))
      .on("tick", tick);

    function clamp(x, lo, hi) {
      return x < lo ? lo : x > hi ? hi : x;
    }

    let swaying = true;
    let prevTime = performance.now();
    let phase = 0;

    function sway(t) {
      let dT = t - prevTime;
      prevTime = t;
      phase += dT * 0.0005;
      nodes = nodes.map(function(node) {
        if (node.id === "t") {
          let sway = Math.sin(phase);
          node.fx = tCoords.x - sway * 15;
          node.fy = tCoords.y - sway * 3;
          entryPoints[1] = [node.fx, node.fy + entryOffset.y];
          entry.attr('d', entryCurve(entryPoints));
        }
        simulation.alpha(1).restart();
        return node;
      });
      if (swaying) {
        requestAnimationFrame(sway);
      }
    }
    sway(prevTime);

    function onDragStart() {
      swaying = false;
    }
    function onDrag(event, d) {
      d.fx = clamp(event.x, 0, width);
      d.fy = clamp(event.y, 0, height);
      if (d.id === "t") {
        entryPoints[1] = [d.fx, d.fy + entryOffset.y];
      }
      if (d.id === "bfl") {
        entryPoints[0] = [
          d.fx + entryOffset.x, d.fy - lineOffset];
      }
      if (d.id === "bfr") {
        entryPoints[2] = [
          d.fx - entryOffset.x, d.fy - lineOffset];
      }
      entry.attr('d', entryCurve(entryPoints));
    }
    function onDragEnd(event, d) {
      if (d.id === "t") {
        tCoords = { x: d.fx, y: d.fy};
      }
      phase = 0;
      prevTime = performance.now();
      swaying = true;
      sway(prevTime);
    }

    const drag = d3.drag()
      .on("start", onDragStart)
      .on("drag", onDrag)
      .on("end", onDragEnd);
    node.call(drag);
    ground.append(svg.node());
  </script>
</html>
